name: Python app - Flow PR report

on:
  pull_request:
    branches: ["main", "develop"]
    types: ["opened", "synchronize", "reopened"]
    paths: ["config/queries.yml"]

permissions:
  contents: read
  actions: write

# Cancela el run anterior de la misma PR
concurrency:
  group: pr-preview-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: true

env:
  MAX_RUNTIME: 300

jobs:
  set-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.one_block.outputs.matrix }}

    steps:
      - uses: actions/checkout@v5
      # Set up python and install dependencies
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip" # caching pip dependencies
          cache-dependency-path: "./requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build matrix from "config/queries.yml"
        id: one_block
        run: |
          python <<'PY'
          import yaml, os, json

          my_file = "config/queries.yml"

          with open(my_file, 'r', encoding='utf8') as f:
              cfg = yaml.safe_load(f) or {}

          # Extraer nombres de los reports
          names = [item['name'] for item in cfg.get('reports', [])]
          print("Matrix names:", names)

          # Guardar en GITHUB_OUTPUT
          with open(os.environ['GITHUB_OUTPUT'], 'a') as gh_output:
              gh_output.write(f"matrix={json.dumps({'name': names})}\n")
          PY

  build:
    needs: set-matrix
    runs-on: ubuntu-latest
    environment: develop

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}

    steps:
      # Basic checkout
      - uses: actions/checkout@v5

      # Set up python and install dependencies
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip" # caching pip dependencies
          cache-dependency-path: "./requirements.txt"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build single-report "config/queries.yml"
        run: |
          python <<'PY'
          import yaml

          name = "${{ matrix.name }}"

          cfg = yaml.safe_load(open("config/queries.yml", "r", encoding="utf-8")) or {}
          rep = [
              report for report in (cfg.get("reports") or []) if report["name"] == name
          ]

          if not rep:
              raise SystemExit(f"No se encontr√≥ 'name={name}' en config/queries.yml")
          cfg["reports"] = rep


          open("config/_one.yml", "w", encoding="utf-8").write(
              yaml.safe_dump(cfg, sort_keys=False, allow_unicode=True)
          )
          PY

      - name: Run python script (dry-run)
        shell: bash
        env:
          NAME: ${{ matrix.name }}
        run: |
          set -euo pipefail
          attempts=3
          delay=2
          start=$SECONDS
          cmd=(python ./artworks-report.py --config "config/_one.yml" --out "out/${NAME}" --dry-run)

          for ((i=1;i<=attempts;i++)); do
              echo "ü§ñ Ejecutando el intento $i de ${attempts} ‚Üí ${cmd[*]}"
              if "${cmd[@]}"; then
                  echo "‚úÖ √âxito en el intento $i"
                  break
              fi
          now=$SECONDS
          elapsed=$(( now - start ))
          if (( elapsed > ${MAX_RUNTIME} )); then
              echo "üõéÔ∏è Upsss, tiempo excedido. Abortando"
              exit 1
          fi

          if (( i < attempts )); then
              echo "üö® Fall√≥ el intento $i. Se esperar√° ${delay}s antes de intentar de nuevo..."
              sleep ${delay}
              delay=$(( delay * 2 ))
          else 
              echo "‚ùå Todos los intentos fallaron..."
              exit 1
          fi
          done


      - name: Upload artifact (one report)
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.name }}
          path: out/${{ matrix.name }}
          if-no-files-found: error
          retention-days: 15

  summarize:
    needs: build
    runs-on: ubuntu-latest

    permissions: 
      contents: read
      actions: read
      pull-requests: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
    
    steps:
      - name: Prepare workspace
        run: mkdir -p out

      - name: Download all report artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: report-*
          merge-multiple: true
          path: out

      - name: Install jq for JSON and HTML
        run: |
          apt-get update
          apt-get install -y jq

      - name: Build PR comment (HTML) from per-report data.json (dynamic columns)
        shell: bash
        env:
          PREVIEW_COLUMNS: "id,name"     # columnas del JSON (separadas por coma)
          PREVIEW_HEADERS: "ID,Nombre"   # cabeceras visibles
          PREVIEW_LIMIT: "10"            # filas m√°ximas a mostrar
        run: |
          set -euo pipefail
          cols="${PREVIEW_COLUMNS:-id,name}"
          headers="${PREVIEW_HEADERS:-}"
          limit="${PREVIEW_LIMIT:-10}"

          {
            echo "<!-- report-preview-marker -->"
            echo "### üßæ Previsualizaci√≥n de reportes"
            echo
            echo "<details><summary>Ver tablas (m√°x. ${limit} filas por reporte)</summary>"
            echo
          } > pr_comment.md

          shopt -s nullglob
          for d in out/*/ ; do
            name="$(basename "$d")"
            js="${d%/}/data.json"
            [[ -f "$js" ]] || js="$(ls "${d%/}"/*.json 2>/dev/null | head -n 1 || true)"
            [[ -f "$js" ]] || continue

            echo "" >> pr_comment.md
            echo "#### ${name}" >> pr_comment.md
            echo "<table><thead><tr>" >> pr_comment.md

            # Cabeceras
            IFS=, read -ra c <<< "$cols"
            if [[ -n "$headers" ]]; then
              IFS=, read -ra h <<< "$headers"
            else
              h=("${c[@]}")
            fi
            for th in "${h[@]}"; do printf '<th>%s</th>' "$th" >> pr_comment.md; done
            echo "</tr></thead><tbody>" >> pr_comment.md

            # Filas (din√°micas): usa las claves indicadas en PREVIEW_COLUMNS
            jq -r --arg cols "$cols" --argjson limit "$limit" '
              def h: tostring|@html;
              ( (type=="array")? . : .data )
              | .[:$limit][] as $row
              | ($cols | split(",")) as $cols
              | "<tr>" + ( $cols
                  | map( "<td>" + ( $row[.] // "" | tostring | h ) + "</td>" )
                  | join("") ) + "</tr>"
            ' "$js" >> pr_comment.md

            echo "</tbody></table>" >> pr_comment.md
          done

          {
            echo
            echo "</details>"
            echo
            echo "<sub>Descarga PDF/JSON completos desde los artifacts de este run.</sub>"
          } >> pr_comment.md

          head -n 20 pr_comment.md
      

      - name: Create/Update sticky PR comment with gh
        if: ${{ env.PR_NUMBER != '' }}
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          MARK="<!-- report-preview-marker -->"

          # Busca comentario previo del bot con el marcador
          CID="$(gh api repos/$OWNER/$REPO/issues/$PR_NUMBER/comments \
                --jq '[.[] | select(.user.type == "Bot" and (.body|contains("'"$MARK"'")))] | .[0].id' \
                | tr -d '\n')"

          if [[ -n "${CID}" && "${CID}" != "null" ]]; then
            echo "üîÅ Actualizando comentario existente ($CID)‚Ä¶"
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /repos/$OWNER/$REPO/issues/comments/$CID \
              -f body="$(cat pr_comment.md)"
          else
            echo "üÜï Creando comentario nuevo‚Ä¶"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/$OWNER/$REPO/issues/$PR_NUMBER/comments \
              -f body="$(cat pr_comment.md)"
          fi
